let messages = document.getElementById("messages");
let input = document.getElementById("input");
let chatBtn = document.getElementById("chatBtn");
let imgBtn = document.getElementById("imgBtn");
let motherBtn = document.getElementById("motherBtn");
let profilePic = document.getElementById("profilePic");
let profileRing = document.getElementById("profileRing");
let voiceBtn = document.getElementById("voiceBtn");

let voiceEnabled = true;
let clickCount = 0;
let username = localStorage.getItem("username") || "";
let password = localStorage.getItem("password") || "";
let age = parseInt(localStorage.getItem("age")) || 0;
let imageHistory = [];

function addMessage(content, who) {
  const div = document.createElement("div");
  div.className = "msg " + who;

  if (content && typeof content === "object" && content.type === "image") {
    const img = document.createElement("img");
    img.src = content.src;
    div.appendChild(img);
    imageHistory.push(content.src);
  } else {
    div.textContent = content;
  }

  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
}

function showTyping() {
  const d = document.createElement("div");
  d.className = "msg ai typing";
  d.textContent = "...";
  messages.appendChild(d);
  return d;
}

function clearChat() { messages.innerHTML = ""; }

function showChat() {
  chatBtn.classList.add("active");
  imgBtn.classList.remove("active");
  clearChat();
}

function showImages() {
  imgBtn.classList.add("active");
  chatBtn.classList.remove("active");
  clearChat();
  imageHistory.forEach(src =>
    addMessage({ type: "image", src }, "ai")
  );
}

function toggleVoice() {
  voiceEnabled = !voiceEnabled;
  voiceBtn.textContent = `ðŸŽ™ï¸ Voice ${voiceEnabled ? "ON" : "OFF"}`;
}

function openShare() {
  navigator.clipboard.writeText(location.href);
  document.getElementById("sharePopup").style.display = "block";
}

function openPeople() {
  document.getElementById("peoplePopup").style.display = "block";
}

function openProfile() {
  document.getElementById("profilePopup").style.display = "block";
}

function closePopups() {
  document.querySelectorAll(".popup").forEach(p => p.style.display = "none");
}

function uploadAvatar() {
  if (!username) {
    alert("Login first!");
    return;
  }

  const f = document.createElement("input");
  f.type = "file";
  f.accept = "image/*";
  f.onchange = e => {
    const file = e.target.files[0];
    profilePic.src = URL.createObjectURL(file);
  };
  f.click();
}

function login() {
  let u = document.getElementById("usernameInput").value.trim();
  let p = document.getElementById("passwordInput").value.trim();
  let a = parseInt(document.getElementById("ageInput").value);

  if (a < 10 || a > 100) {
    alert("Age must be 10-100");
    return;
  }

  username = u;
  password = p;
  age = a;

  localStorage.setItem("username", u);
  localStorage.setItem("password", p);
  localStorage.setItem("age", a);
  closePopups();
}

function logout() {
  username = "";
  password = "";
  age = 0;
  localStorage.clear();
}

function clickMother() {
  clickCount++;
  if (clickCount >= 100) {
    profileRing.style.display = "block";
    alert("Decorative ring unlocked!");
    clickCount = 0;
  }
}

/* ðŸ”§ FIXED AI RESPONSE + IMAGE GENERATION */
async function aiResponse(text) {
  let t = text.toLowerCase().trim();

  if (t === "doodledog6767")
    return "Secret link: https://www.youtube.com/watch?v=dQw4w9WgXcQ";

  let slang = {
    gtg: "Alright, later.",
    brb: "Okay.",
    lol: "Yeah",
    idk: "Thatâ€™s fine.",
    fr: "For real."
  };
  if (slang
